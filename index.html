// index.html
const htmlTemplate = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Listings</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div class="search-container my-4">
            <input type="text" id="searchInput" class="form-control" placeholder="Search by address, ZIP code, or type...">
            <div id="autocomplete-list" class="autocomplete-list"></div>
        </div>

        <div id="results-controls">
            <div class="sort-view-container">
                <div class="sort-container">
                    <select id="sortSelect" class="form-select">
                        <option value="">Sort By...</option>
                        <option value="price-low">Price (Low to High)</option>
                        <option value="price-high">Price (High to Low)</option>
                        <option value="sqft-low">Sq. Feet (Low to High)</option>
                        <option value="sqft-high">Sq. Feet (High to Low)</option>
                        <option value="recent">Most Recent</option>
                    </select>
                </div>

                <div class="view-options">
                    <button class="btn btn-outline-primary active" data-view="list">List</button>
                    <button class="btn btn-outline-primary" data-view="tile">Tile</button>
                    <button class="btn btn-primary" id="saveSearch">Save Search</button>
                </div>
            </div>

            <div id="property-grid"></div>

            <div id="pagination" class="my-4"></div>
        </div>
    </div>

    <div class="modal fade" id="myModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Get Access Now!</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-4">Property Details are available for REGISTERED MEMBERS ONLY.</p>
                    <button class="btn btn-primary w-100 mb-3">Apply Now</button>
                    <p class="small text-muted">By clicking the button, I agree to the Terms and Conditions...</p>
                    <div class="bbb-container mt-4">
                        <img src="bbb-logo.jpg" alt="BBB Accredited Business" class="bbb-logo mb-2">
                        <p class="small">Registering for our Membership gives you access to our full listings...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
`;

// styles.css
const styles = `
.new-properties-container {
    margin-bottom: 2rem;
    width: 100%;
}

.new-property-card {
    display: flex;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
    width: 100%;
}

.image-gallery {
    flex: 0 0 60%;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    grid-template-rows: 300px 150px;
    gap: 4px;
    padding: 4px;
    background: #f8f9fa;
}

.gallery-main {
    grid-column: 1 / -1;
    grid-row: 1;
    position: relative;
}

.gallery-thumb {
    height: 100%;
    width: 100%;
    position: relative;
    cursor: pointer;
    transition: opacity 0.2s;
}

.gallery-thumb:hover {
    opacity: 0.9;
}

.gallery-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 4px;
}

.property-info {
    flex: 0 0 40%;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
}

.property-price {
    font-size: 2rem;
    font-weight: bold;
    color: #2c3e50;
    margin-bottom: 1rem;
}

.property-address {
    font-size: 1.2rem;
    color: #34495e;
    margin-bottom: 1rem;
    line-height: 1.4;
}

.property-details {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.property-detail-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #666;
}

.detail-icon {
    font-size: 1.2rem;
}

.property-type {
    display: inline-block;
    padding: 0.5rem 1rem;
    background: #e9ecef;
    border-radius: 4px;
    margin-bottom: 1.5rem;
    color: #495057;
    font-weight: 500;
}

.contact-btn {
    margin-top: auto;
    padding: 1rem;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    font-weight: 500;
}

.contact-btn:hover {
    background: #0056b3;
    transform: translateY(-1px);
}

.old-properties-container {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-top: 2rem;
}

.old-property-card {
    flex: 0 0 calc(33.333% - 1rem);
    margin-bottom: 1rem;
}

.old-property-card .card {
    height: 100%;
    transition: transform 0.2s;
}

.old-property-card .card:hover {
    transform: translateY(-2px);
}

.old-property-card .card-img-top {
    height: 200px;
    object-fit: cover;
}

.search-container {
    position: relative;
}

.autocomplete-list {
    position: absolute;
    width: 100%;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    max-height: 300px;
    overflow-y: auto;
    z-index: 1000;
    border-radius: 0 0 4px 4px;
}

.sort-view-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
}

.view-options {
    display: flex;
    gap: 0.5rem;
}

@media (max-width: 768px) {
    .new-property-card {
        flex-direction: column;
    }
    
    .image-gallery {
        grid-template-rows: 200px 100px;
    }
    
    .property-info {
        flex: none;
    }
    
    .property-details {
        grid-template-columns: 1fr;
    }
    
    .old-property-card {
        flex: 0 0 100%;
    }
    
    .sort-view-container {
        flex-direction: column;
        gap: 1rem;
    }
    
    .view-options {
        width: 100%;
        justify-content: center;
    }
}
`;

// app.js
const app = {
    properties: [],
    currentPage: 1,
    itemsPerPage: 9,
    currentView: 'list',
    
    async init() {
        await this.loadProperties();
        this.setupEventListeners();
        this.displayProperties();
        this.setupPagination();
    },
    
    async loadProperties() {
        try {
            // Загружаем все JSON файлы из папки data
            const response = await fetch('https://api.github.com/repos/satpel/eal-estate-data/contents/data');
            const files = await response.json();
            
            for (const file of files) {
                if (file.name.endsWith('.json')) {
                    const dataResponse = await fetch(file.download_url);
                    const propertyData = await dataResponse.json();
                    this.properties = [...this.properties, ...propertyData];
                }
            }
            
            // Сортируем по priority
            this.properties.sort((a, b) => (b.priority || 0) - (a.priority || 0));
        } catch (error) {
            console.error('Error loading properties:', error);
        }
    },
    
    setupEventListeners() {
        // Search
        document.getElementById('searchInput').addEventListener('input', (e) => {
            this.handleSearch(e.target.value);
        });
        
        // Sort
        document.getElementById('sortSelect').addEventListener('change', (e) => {
            this.handleSort(e.target.value);
        });
        
        // View options
        document.querySelectorAll('[data-view]').forEach(button => {
            button.addEventListener('click', (e) => {
                this.changeView(e.target.dataset.view);
            });
        });
        
        // Pagination
        document.getElementById('pagination').addEventListener('click', (e) => {
            if (e.target.dataset.page) {
                this.currentPage = parseInt(e.target.dataset.page);
                this.displayProperties();
            }
        });
    },
    
    handleSearch(query) {
        const filteredProperties = this.properties.filter(property => {
            const searchString = `${property.address} ${property.zipCode} ${property.type}`.toLowerCase();
            return searchString.includes(query.toLowerCase());
        });
        
        this.currentPage = 1;
        this.displayProperties(filteredProperties);
    },
    
    handleSort(sortBy) {
        const sorted = [...this.properties];
        
        switch(sortBy) {
            case 'price-low':
                sorted.sort((a, b) => (a.price || 0) - (b.price || 0));
                break;
            case 'price-high':
                sorted.sort((a, b) => (b.price || 0) - (a.price || 0));
                break;
            case 'sqft-low':
                sorted.sort((a, b) => (parseFloat(a.squareFeet) || 0) - (parseFloat(b.squareFeet) || 0));
                break;
            case 'sqft-high':
                sorted.sort((a, b) => (parseFloat(b.squareFeet) || 0) - (parseFloat(a.squareFeet) || 0));
                break;
            case 'recent':
                sorted.sort((a, b) => (b.priority || 0) - (a.priority || 0));
                break;
        }
        
        this.properties = sorted;
        this.displayProperties();
    },
    
    displayProperties(propertiesToShow = this.properties) {
        const propertyGrid = document.getElementById('property-grid');
        propertyGrid.innerHTML = '';
        
        // Разделяем свойства на новые и старые
        const newProperties = propertiesToShow.filter(prop => prop.id.startsWith('prop_'));
        const oldProperties = propertiesToShow.filter(prop => !prop.id.startsWith('prop_'));
        
        // Отображаем новые свойства
        if (newProperties.length > 0) {
            const newPropertiesContainer = document.createElement('div');
            newPropertiesContainer.className = 'new-properties-container';
            
            newProperties.forEach(property => {
                newPropertiesContainer.appendChild(this.createNewPropertyCard(property));
            });
            
            propertyGrid.appendChild(newPropertiesContainer);
        }
        
        // Отображаем старые свойства с пагинацией
        if (oldProperties.length > 0) {
            const startIndex = (this.currentPage - 1) * this.itemsPerPage;
            const endIndex = startIndex + this.itemsPerPage;
            const paginatedProperties = oldProperties.slice(startIndex, endIndex);
            
            const oldPropertiesContainer = document.createElement('div');
            oldPropertiesContainer.className = 'old-properties-container row';
            
            paginatedProperties.forEach(property => {
                oldPropertiesContainer.appendChild(this.createOldPropertyCard(property));
            });
            
            propertyGrid.appendChild(oldPropertiesContainer);
        }
        
        this.setupPagination(oldProperties.length);
    },
    
		// Обновляем функцию создания карточки нового дома
		function createNewPropertyCard(property) {
		    const card = document.createElement('div');
		    card.className = 'new-property-card';
		    
		    // Создаем галерею изображений
		    const gallery = document.createElement('div');
		    gallery.className = 'image-gallery';
		    
		    const images = [property.imageUrl, property.imageUrl2, property.imageUrl3].filter(Boolean);
		    
		    // Главное изображение
		    const mainImageContainer = document.createElement('div');
		    mainImageContainer.className = 'gallery-main';
		    mainImageContainer.innerHTML = `
		        <img src="${images[0]}" alt="Main Property View" class="gallery-image">
		    `;
		    gallery.appendChild(mainImageContainer);
		    
		    // Дополнительные изображения
		    images.slice(1).forEach((imgUrl, index) => {
		        const thumbContainer = document.createElement('div');
		        thumbContainer.className = 'gallery-thumb';
		        thumbContainer.innerHTML = `
		            <img src="${imgUrl}" alt="Property View ${index + 2}" class="gallery-image">
		        `;
		        gallery.appendChild(thumbContainer);
		    });
		    
		    // Информация о собственности
		    const info = document.createElement('div');
		    info.className = 'property-info';
		    info.innerHTML = `
		        <div class="property-price">$${property.price ? property.price.toLocaleString() : 'Contact for Price'}</div>
		        <div class="property-address">${property.address}</div>
		        <div class="property-details">
		            <div class="property-detail-item">
		                <span class="detail-icon">🛏️</span>
		                <span>${property.beds} Beds</span>
		            </div>
		            <div class="property-detail-item">
		                <span class="detail-icon">🚿</span>
		                <span>${property.baths} Baths</span>
		            </div>
		            ${property.squareFeet ? `
		                <div class="property-detail-item">
		                    <span class="detail-icon">📏</span>
		                    <span>${property.squareFeet} sqft</span>
		                </div>
		            ` : ''}
		            <div class="property-detail-item">
		                <span class="detail-icon">📍</span>
		                <span>${property.zipCode}</span>
		            </div>
		        </div>
		        <div class="property-type">${property.type}</div>
		        <button class="contact-btn" onclick="app.showModal('${property.id}')">Contact Agent</button>
		    `;
		    
		    card.appendChild(gallery);
		    card.appendChild(info);
		    
		    return card;
		}
    
    getPropertyImages(property) {
        const images = [];
        if (property.imageUrl) images.push(property.imageUrl);
        if (property.imageUrl2) images.push(property.imageUrl2);
        if (property.imageUrl3) images.push(property.imageUrl3);
        return images;
    },
    
    createImageSlider(images) {
        const slider = document.createElement('div');
        slider.className = 'property-image-slider';
        
        images.forEach((imgUrl, index) => {
            const imgContainer = document.createElement('div');
            imgContainer.className = 'slider-image';
            
            const img = document.createElement('img');
            img.src = imgUrl;
            img.alt = `Property Image ${index + 1}`;
            
            imgContainer.appendChild(img);
            slider.appendChild(imgContainer);
        });
        
        if (images.length > 1) {
            this.addSliderNavigation(slider, images.length);
        }
        
        return slider;
    },
    
    addSliderNavigation(slider, imageCount) {
        const nav = document.createElement('div');
        nav.className = 'slider-nav';
        
        for (let i = 0; i < imageCount; i++) {
            const dot = document.createElement('div');
            dot.className = 'slider-dot' + (i === 0 ? ' active' : '');
            dot.addEventListener('click', () => {
                slider.scrollTo({
                    left: slider.offsetWidth * i,
                    behavior: 'smooth'
                });
            });
            nav.appendChild(dot);
        }
        
        slider.appendChild(nav);
    },
    
		createPropertyInfo(property) {
        const info = document.createElement('div');
        info.className = 'property-info';
        
        info.innerHTML = `
            <h2 class="property-price">$${property.price ? property.price.toLocaleString() : 'Contact for Price'}</h2>
            <p class="property-address">${property.address}</p>
            <div class="property-details">
                <span class="beds">${property.beds} Beds</span>
                <span class="baths">${property.baths} Baths</span>
                ${property.squareFeet ? `<span class="sqft">${property.squareFeet} sqft</span>` : ''}
            </div>
            <div class="property-type">${property.type}</div>
            <button class="contact-btn" onclick="app.showModal('${property.id}')">Contact Agent</button>
        `;
        
        return info;
    },
    
    createOldPropertyCard(property) {
        const card = document.createElement('div');
        card.className = 'col-md-4 old-property-card';
        
        card.innerHTML = `
            <div class="card">
                <img src="${property.imageUrl}" class="card-img-top" alt="Property Image" 
                     onerror="this.src='placeholder-image.jpg'">
                <div class="card-body">
                    <h5 class="card-title">ZIP: ${property.zipCode}</h5>
                    <p class="card-text">
                        ${property.beds} Beds, ${property.baths} Baths
                        ${property.squareFeet ? `<br>${property.squareFeet} sqft` : ''}
                    </p>
                    <button class="btn btn-primary w-100" onclick="app.showModal('${property.id}')">View Details</button>
                </div>
            </div>
        `;
        
        return card;
    },
    
    setupPagination(totalItems = this.properties.length) {
        const paginationContainer = document.getElementById('pagination');
        paginationContainer.innerHTML = '';
        
        const totalPages = Math.ceil(totalItems / this.itemsPerPage);
        if (totalPages <= 1) return;
        
        const ul = document.createElement('ul');
        ul.className = 'pagination';
        
        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${this.currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `
            <a class="page-link" href="#" ${this.currentPage === 1 ? '' : `data-page="${this.currentPage - 1}"`}>
                Previous
            </a>
        `;
        ul.appendChild(prevLi);
        
        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
            if (
                i === 1 || 
                i === totalPages || 
                (i >= this.currentPage - 1 && i <= this.currentPage + 1)
            ) {
                const li = document.createElement('li');
                li.className = `page-item ${i === this.currentPage ? 'active' : ''}`;
                li.innerHTML = `
                    <a class="page-link" href="#" data-page="${i}">${i}</a>
                `;
                ul.appendChild(li);
            } else if (
                i === this.currentPage - 2 || 
                i === this.currentPage + 2
            ) {
                const li = document.createElement('li');
                li.className = 'page-item disabled';
                li.innerHTML = '<a class="page-link">...</a>';
                ul.appendChild(li);
            }
        }
        
        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${this.currentPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `
            <a class="page-link" href="#" ${this.currentPage === totalPages ? '' : `data-page="${this.currentPage + 1}"`}>
                Next
            </a>
        `;
        ul.appendChild(nextLi);
        
        paginationContainer.appendChild(ul);
    },
    
    showModal(propertyId) {
        const modal = new bootstrap.Modal(document.getElementById('myModal'));
        modal.show();
    },
    
    changeView(viewType) {
        this.currentView = viewType;
        
        // Update active button
        document.querySelectorAll('[data-view]').forEach(button => {
            button.classList.toggle('active', button.dataset.view === viewType);
        });
        
        // Update display
        const propertyGrid = document.getElementById('property-grid');
        propertyGrid.className = viewType === 'tile' ? 'row g-4' : 'row';
        
        this.displayProperties();
    }
};

// Initialize the app
document.addEventListener('DOMContentLoaded', () => {
    // Add styles to the document
    const styleSheet = document.createElement('style');
    styleSheet.textContent = styles;
    document.head.appendChild(styleSheet);
    
    // Initialize the application
    app.init();
});
